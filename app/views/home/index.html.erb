<% title 'Dashboard' %>

<div class="container-fluid py-4">
  <% if @current_user_profile == 1 %>
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bg-dark border-secondary">
          <div class="card-body">
            <%= form_with url: root_path, method: :get, local: true, class: "row g-3" do |f| %>
              <div class="col-md-4">
                <label class="form-label text-light fw-bold">Filtrar por Vendedor</label>
                <%= select_tag :seller_id, 
                    options_from_collection_for_select(@sellers, :id, :name, params[:seller_id]), 
                    { include_blank: "Todos os vendedores", class: "form-select bg-dark text-white border-secondary" } %>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <%= submit_tag "Filtrar", class: "btn btn-primary w-100" %>
              </div>
              <% if params[:seller_id].present? %>
                <div class="col-md-2 d-flex align-items-end">
                  <%= link_to "Limpar Filtros", root_path, class: "btn btn-secondary w-100" %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
      <%= link_to orders_path, class: "text-decoration-none" do %>
        <div class="card bg-primary text-white shadow h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white mb-1 fw-light">Total de Pedidos</h6>
                <h2 class="mb-0 text-white fw-bold"><%= @total_orders %></h2>
              </div>
              <div class="fs-1 opacity-50">
                <i class="fas fa-shopping-cart"></i>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
      <div class="card bg-success text-white shadow h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-white mb-1 fw-light">Pedidos Integrados</h6>
              <h2 class="mb-0 text-white fw-bold"><%= @orders_integrated %></h2>
            </div>
            <div class="fs-1 opacity-50">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Adicionado link para ver pedidos pendentes -->
    <div class="col-xl-3 col-md-6 mb-3">
      <%= link_to orders_path(status: 'pending'), class: "text-decoration-none" do %>
        <div class="card bg-warning text-white shadow h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white mb-1 fw-light">Pedidos Pendentes</h6>
                <h2 class="mb-0 text-white fw-bold"><%= @orders_pending %></h2>
              </div>
              <div class="fs-1 opacity-50">
                <i class="fas fa-clock"></i>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Adicionado link para ver pedidos de hoje -->
    <div class="col-xl-3 col-md-6 mb-3">
      <%= link_to orders_path(date: 'today'), class: "text-decoration-none" do %>
        <div class="card bg-info text-white shadow h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-white mb-1 fw-light">Pedidos Hoje</h6>
                <h2 class="mb-0 text-white fw-bold"><%= @orders_today.count %></h2>
              </div>
              <div class="fs-1 opacity-50">
                <i class="fas fa-calendar-day"></i>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row">
    <!-- Pedidos por Dia -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-secondary">
          <h5 class="mb-0 text-light fw-bold">Pedidos por Dia (Últimos 7 dias)</h5>
        </div>
        <div class="card-body">
          <%= area_chart @orders_by_day,
              height: "300px",
              colors: ["#4bc0c0"],
              library: {
                chart: { background: 'transparent' },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2 },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2 } },
                dataLabels: { enabled: false },
                grid: { borderColor: '#444' },
                xaxis: { labels: { style: { colors: '#e0e0e0' } } },
                yaxis: { labels: { style: { colors: '#e0e0e0' } } }
              } %>
        </div>
      </div>
    </div>

    <!-- Pedidos por Destino -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-secondary">
          <h5 class="mb-0 text-light fw-bold">Pedidos por Destino</h5>
        </div>
        <div class="card-body">
          <%= bar_chart @orders_by_destiny,
              height: "300px",
              colors: ["#ff6384"],
              library: {
                chart: { background: 'transparent' },
                theme: { mode: 'dark' },
                legend: { labels: { colors: '#e0e0e0' } },
                dataLabels: { style: { colors: ['#fff'] } }
              } %>
        </div>
      </div>
    </div>

    <!-- Pedidos por Vendedor -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-secondary">
          <h5 class="mb-0 text-light fw-bold">Top 10 Vendedores</h5>
        </div>
        <div class="card-body">
          <%= column_chart @orders_by_seller,
              height: "300px",
              colors: ["#36a2eb"],
              library: {
                chart: { background: 'transparent' },
                theme: { mode: 'dark' },
                plotOptions: { bar: { borderRadius: 4, dataLabels: { position: 'top' } } },
                dataLabels: { enabled: true, style: { colors: ['#e0e0e0'] } },
                grid: { borderColor: '#444' },
                xaxis: { labels: { style: { colors: '#e0e0e0' } } },
                yaxis: { labels: { style: { colors: '#e0e0e0' } } }
              } %>
        </div>
      </div>
    </div>

    <!-- Métodos de Pagamento -->
    <div class="col-lg-6 mb-4">
      <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-secondary">
          <h5 class="mb-0 text-light fw-bold">Métodos de Pagamento</h5>
        </div>
        <div class="card-body">
          <%= bar_chart @payment_methods,
              height: "300px",
              colors: ["#9966ff"],
              library: {
                chart: { background: 'transparent' },
                theme: { mode: 'dark' },
                plotOptions: { bar: { horizontal: true, borderRadius: 4 } },
                dataLabels: { enabled: true, style: { colors: ['#e0e0e0'] } },
                grid: { borderColor: '#444' },
                xaxis: { labels: { style: { colors: '#e0e0e0' } } },
                yaxis: { labels: { style: { colors: '#e0e0e0' } } }
              } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Adicionar seção de últimos pedidos -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card bg-dark border-secondary shadow">
        <div class="card-header bg-secondary">
          <h5 class="mb-0 text-light fw-bold">Últimos 5 Pedidos</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th class="text-light">ID</th>
                  <th class="text-light">Cliente</th>
                  <th class="text-light">Vendedor</th>
                  <th class="text-light">Destino</th>
                  <th class="text-light">Status</th>
                  <th class="text-light">Data</th>
                  <th class="text-light">Ações</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_orders.each do |order| %>
                  <tr>
                    <td class="text-light">#<%= order.id %></td>
                    <td class="text-light"><%= order.contact&.nome || 'N/A' %></td>
                    <td class="text-light"><%= order.seller_name || 'N/A' %></td>
                    <td class="text-light">
                      <span class="badge <%= order.destiny == 'primeiros_passos' ? 'bg-info' : 'bg-primary' %>">
                        <%= order.destiny&.humanize || 'N/A' %>
                      </span>
                    </td>
                    <td class="text-light">
                      <% if order.tiny_order_id.present? %>
                        <span class="badge bg-success">Integrado</span>
                      <% else %>
                        <span class="badge bg-warning">Pendente</span>
                      <% end %>
                    </td>
                    <td class="text-light"><%= order.created_at.strftime('%d/%m/%Y %H:%M') %></td>
                    <td>
                      <%= link_to 'Ver', order_path(order), class: 'btn btn-sm btn-outline-primary' %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <%= link_to 'Ver Todos os Pedidos', orders_path, class: 'btn btn-primary' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
